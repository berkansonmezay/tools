<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otomatik Ders Programı - Öğretmenler</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        .import-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 40px;
            border-radius: var(--radius);
            text-align: center;
            border: 2px dashed var(--primary-blue);
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .import-section:hover {
            border-color: var(--primary-purple);
            transform: translateY(-2px);
        }

        .import-icon {
            font-size: 3.5rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: var(--primary-blue);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            display: inline-block;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(9, 132, 227, 0.4);
        }

        .teacher-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--radius);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
        }

        .form-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-input-group label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .form-input-group input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .form-input-group input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(9, 132, 227, 0.1);
        }

        .add-teacher-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-teacher-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge.blue {
            background: #e3f2fd;
            color: #1976d2;
        }

        .hour-badge {
            background: #fff3e0;
            color: #ef6c00;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.95rem;
            border: 2px solid #ffe0b2;
        }

        .class-tag {
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            border: 2px solid #e0e0e0;
            margin-right: 6px;
            display: inline-block;
            margin-bottom: 4px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="app-wrapper">
        <!-- Modern Header -->
        <header class="modern-header">
            <div class="logo-section">
                <img src="C:/Users/BS/.gemini/antigravity/brain/70137e88-df51-4e31-97d8-731b233d7d22/uploaded_media_1769600595669.png"
                    alt="Logo" class="app-logo-modern">
            </div>
            <h1 class="app-title-modern">Otomatik Ders Programı Hazırlama Uygulaması</h1>
        </header>

        <!-- Stepper -->
        <div class="stepper-container">
            <div class="stepper">
                <div class="step completed" onclick="window.location.href='index.html'">
                    <div class="step-circle"><i class="fas fa-check"></i></div>
                    <div class="step-label">Zaman Planı</div>
                </div>
                <div class="step-line"></div>
                <div class="step active" data-step="2">
                    <div class="step-circle"><i class="fas fa-users"></i></div>
                    <div class="step-label">Öğretmenler</div>
                </div>
                <div class="step-line"></div>
                <div class="step" onclick="window.location.href='filters.html'">
                    <div class="step-circle"><i class="fas fa-filter"></i></div>
                    <div class="step-label">Kısıtlamalar</div>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="modern-container">
            <div class="page-header">
                <h2><i class="fas fa-users"></i> 2. Adım: Öğretmen Yönetimi</h2>
                <p>Öğretmen bilgilerini Excel'den aktarın veya manuel olarak ekleyin</p>
            </div>

            <!-- Excel Import -->
            <section class="import-section" id="dropZone">
                <i class="fas fa-file-excel import-icon"></i>
                <h3>Excel'den Öğretmen Aktar</h3>
                <p>Excel dosyanızı buraya sürükleyin veya dosyayı seçin</p>
                <label for="excelFile" class="upload-btn"><i class="fas fa-upload"></i> Dosya Seç</label>
                <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
                <div style="margin-top: 15px; font-size: 0.85rem; color: #666;">
                    <strong>Sütunlar:</strong> Ad Soyad, Branş, Sınıf-Saat (Örn: MAT-12-A-3)
                </div>
            </section>

            <!-- Manual Entry -->
            <section class="teacher-form">
                <div class="form-input-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="tName" placeholder="Örn: Ahmet Yılmaz">
                </div>
                <div class="form-input-group" style="grid-column: span 2;">
                    <label>Branş (Birden fazla seçebilirsiniz)</label>
                    <div style="position: relative;">
                        <button type="button" id="branchDropdownToggle"
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; text-align: left; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            <span id="branchSelectedText" style="color: #999;">Branş seçin...</span>
                            <i class="fas fa-chevron-down" id="branchDropdownIcon"></i>
                        </button>
                        <div id="branchCheckboxes"
                            style="display: none; position: absolute; z-index: 1000; width: 100%; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 5px;">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Matematik" class="branch-checkbox">
                                    Matematik
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Türkçe" class="branch-checkbox"> Türkçe
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="İngilizce" class="branch-checkbox">
                                    İngilizce
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Fen Bilimleri" class="branch-checkbox">
                                    Fen Bilimleri
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Sosyal Bilgiler"
                                        class="branch-checkbox"> Sosyal Bilgiler
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Din Kültürü" class="branch-checkbox">
                                    Din Kültürü
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Fizik" class="branch-checkbox"> Fizik
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Kimya" class="branch-checkbox"> Kimya
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Biyoloji" class="branch-checkbox">
                                    Biyoloji
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Tarih" class="branch-checkbox"> Tarih
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Coğrafya" class="branch-checkbox">
                                    Coğrafya
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Felsefe" class="branch-checkbox">
                                    Felsefe
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Edebiyat" class="branch-checkbox">
                                    Edebiyat
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Almanca" class="branch-checkbox">
                                    Almanca
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Fransızca" class="branch-checkbox">
                                    Fransızca
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Görsel Sanatlar"
                                        class="branch-checkbox"> Görsel Sanatlar
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Müzik" class="branch-checkbox"> Müzik
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Beden Eğitimi" class="branch-checkbox">
                                    Beden Eğitimi
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Bilişim Teknolojileri"
                                        class="branch-checkbox"> Bilişim Teknolojileri
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Rehberlik" class="branch-checkbox">
                                    Rehberlik
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Teknoloji Tasarım"
                                        class="branch-checkbox"> Teknoloji Tasarım
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Geometri" class="branch-checkbox">
                                    Geometri
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Mantık" class="branch-checkbox"> Mantık
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Psikoloji" class="branch-checkbox">
                                    Psikoloji
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" name="branch" value="Sosyoloji" class="branch-checkbox">
                                    Sosyoloji
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-input-group" style="grid-column: span 2;">
                    <label>Sınıflar, Şubeler ve Haftalık Ders Saatleri (Ders Kısaltması-Sınıf-Şube-Haftalık Ders Saati,
                        virgülle ayırın)</label>
                    <input type="text" id="tClasses" placeholder="Örn: MAT-12-A-6, FİZ-12-B-4">
                </div>
                <button class="add-teacher-btn" id="addTeacherManual"><i class="fas fa-plus"></i> Ekle</button>
            </section>

            <!-- Teacher List -->
            <div class="hours-table-wrapper">
                <!-- Toolbar for Export/Import -->
                <div class="day-toolbar" style="margin-bottom: 15px;">
                    <div class="day-title">
                        <i class="fas fa-users"></i>
                        <span>Öğretmen Listesi</span>
                    </div>
                    <div class="toolbar-actions">
                        <button id="exportExcelBtn" class="action-btn green"><i class="fas fa-file-excel"></i>
                            Excel'e Aktar</button>
                        <label for="importExcelFile" class="action-btn orange" style="margin: 0; cursor: pointer;">
                            <i class="fas fa-file-upload"></i> Excel'den Yükle
                        </label>
                        <input type="file" id="importExcelFile" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>

                <table class="hours-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>AD SOYAD</th>
                            <th>BRANŞ</th>
                            <th>SINIFLAR VE SAATLERİ</th>
                            <th>TOPLAM SAAT</th>
                            <th>İŞLEM</th>
                        </tr>
                    </thead>
                    <tbody id="teacherRowsContainer"></tbody>
                </table>
            </div>

            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                <button class="modern-next-btn" onclick="window.location.href='index.html'"
                    style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                    <i class="fas fa-arrow-left"></i>
                    <span>Önceki Adım</span>
                </button>
                <button class="modern-next-btn" onclick="window.location.href='filters.html'">
                    <span>Sonraki Adım</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let teachers = JSON.parse(localStorage.getItem('teachers')) || [];

        // Migrate old data format to new format
        teachers = teachers.map(teacher => {
            // If teacher doesn't have classHours, migrate it
            if (!teacher.classHours) {
                // Old format had 'classes' array and 'hours' number
                const classHours = [];
                if (teacher.classes && teacher.classes.length > 0) {
                    const hoursPerClass = Math.ceil((teacher.hours || 0) / teacher.classes.length);
                    teacher.classes.forEach(className => {
                        classHours.push({
                            className: className,
                            hours: hoursPerClass
                        });
                    });
                }
                return {
                    ...teacher,
                    classHours: classHours,
                    totalHours: teacher.hours || 0
                };
            }
            return teacher;
        });

        // Save migrated data
        localStorage.setItem('teachers', JSON.stringify(teachers));

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing...');
            init();
        });

        function init() {
            console.log('Init called');
            renderTeachers();
            setupEventListeners();
        }

        function setupEventListeners() {
            const nameInput = document.getElementById('tName');
            const classesInput = document.getElementById('tClasses');
            const addManualBtn = document.getElementById('addTeacherManual');
            const fileInput = document.getElementById('excelFile');
            const dropZone = document.getElementById('dropZone');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const importExcelFile = document.getElementById('importExcelFile');

            console.log('Elements found:', {
                name: !!nameInput,
                classes: !!classesInput,
                button: !!addManualBtn
            });

            if (!addManualBtn) {
                console.error('Add button not found!');
                return;
            }

            // Branch dropdown toggle
            const branchDropdownToggle = document.getElementById('branchDropdownToggle');
            const branchCheckboxesContainer = document.getElementById('branchCheckboxes');
            const branchDropdownIcon = document.getElementById('branchDropdownIcon');
            const branchSelectedText = document.getElementById('branchSelectedText');

            if (branchDropdownToggle) {
                branchDropdownToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isVisible = branchCheckboxesContainer.style.display === 'block';
                    branchCheckboxesContainer.style.display = isVisible ? 'none' : 'block';
                    branchDropdownIcon.className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (!branchDropdownToggle.contains(e.target) && !branchCheckboxesContainer.contains(e.target)) {
                        branchCheckboxesContainer.style.display = 'none';
                        branchDropdownIcon.className = 'fas fa-chevron-down';
                    }
                });

                // Update selected text when checkboxes change
                const updateSelectedText = function () {
                    const checked = document.querySelectorAll('input[name="branch"]:checked');
                    if (checked.length === 0) {
                        branchSelectedText.textContent = 'Branş seçin...';
                        branchSelectedText.style.color = '#999';
                    } else {
                        const branches = Array.from(checked).map(cb => cb.value);
                        branchSelectedText.textContent = branches.join(', ');
                        branchSelectedText.style.color = '#333';
                    }
                };

                // Add change listeners to all branch checkboxes
                document.querySelectorAll('.branch-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateSelectedText);
                });
            }

            // Manual add
            addManualBtn.addEventListener('click', function (e) {
                e.preventDefault();
                console.log('Button clicked!');

                const name = nameInput.value.trim();
                // Collect all checked branches from checkboxes
                const branchCheckboxes = document.querySelectorAll('input[name="branch"]:checked');
                const branches = Array.from(branchCheckboxes).map(cb => cb.value);
                const branch = branches.join(', '); // Store as comma-separated string
                const classesStr = classesInput.value.trim();

                console.log('Values:', { name, branch, branches, classesStr });

                if (!name || branches.length === 0 || !classesStr) {
                    alert('Lütfen tüm alanları doldurun.\nEn az bir branş seçin.\nFormat: 9A-5, 10B-3');
                    return;
                }

                try {
                    addTeacher(name, branch, classesStr);
                    nameInput.value = '';
                    // Uncheck all branch checkboxes
                    branchCheckboxes.forEach(cb => cb.checked = false);
                    // Reset dropdown text
                    if (branchSelectedText) {
                        branchSelectedText.textContent = 'Branş seçin...';
                        branchSelectedText.style.color = '#999';
                    }
                    classesInput.value = '';
                } catch (error) {
                    console.error('Error:', error);
                    alert('Hata: ' + error.message);
                }
            });

            // File input (original drag-drop area)
            if (fileInput) {
                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) processFile(file);
                });
            }

            // Excel Export
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', exportToExcel);
            }

            // Excel Import (toolbar button)
            if (importExcelFile) {
                importExcelFile.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        processFile(file);
                        e.target.value = ''; // Reset file input
                    }
                });
            }

            // Drag and drop
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#0984e3';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = '#d1d8e0';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#d1d8e0';
                    if (e.dataTransfer.files.length > 0) {
                        processFile(e.dataTransfer.files[0]);
                    }
                });
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                jsonData.forEach((row, index) => {
                    if (index === 0 && row[0] && row[0].toString().toLowerCase().includes('ad')) return;
                    if (row[0] && row[1] && row[2]) {
                        addTeacher(row[0].toString(), row[1].toString(), row[2].toString());
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function parseClassHours(classesStr) {
            const parts = classesStr.split(',').map(p => p.trim()).filter(p => p !== '');
            const classHours = [];

            parts.forEach(part => {
                // Try new format: Subject-Grade-Branch-Hours (e.g., MAT-12-A-6)
                // or Subject-Class-Hours (e.g., MAT-12A-6)
                const segments = part.split('-');

                if (segments.length === 4) {
                    // MAT-12-A-6 -> Subject: MAT, Class: 12-A, Hours: 6
                    classHours.push({
                        subject: segments[0].trim(),
                        className: `${segments[1].trim()}-${segments[2].trim()}`,
                        hours: parseInt(segments[3])
                    });
                } else if (segments.length === 3) {
                    // MAT-12A-6 -> Subject: MAT, Class: 12A, Hours: 6
                    // OR 12-A-6 (Old format with hyphenated class) -> Class: 12-A, Hours: 6
                    const lastPart = parseInt(segments[2]);
                    if (isNaN(parseInt(segments[0]))) {
                        // First part is likely text (Subject), so MAT-12A-6
                        classHours.push({
                            subject: segments[0].trim(),
                            className: segments[1].trim(),
                            hours: lastPart
                        });
                    } else {
                        // First part is number (Grade), so 12-A-6
                        classHours.push({
                            className: `${segments[0].trim()}-${segments[1].trim()}`,
                            hours: lastPart
                        });
                    }
                } else if (segments.length === 2) {
                    // Old format: 12A-6
                    classHours.push({
                        className: segments[0].trim(),
                        hours: parseInt(segments[1])
                    });
                }
            });

            return classHours;
        }

        function addTeacher(name, branch, classesStr) {
            console.log('Adding teacher:', { name, branch, classesStr });

            const classHours = parseClassHours(classesStr);

            if (classHours.length === 0) {
                alert('Geçersiz format! Örnek: MAT-12-A-6, FİZ-10-B-4');
                return;
            }

            const totalHours = classHours.reduce((sum, ch) => sum + ch.hours, 0);

            teachers.push({
                id: Date.now() + Math.random(),
                name,
                branch,
                classHours: classHours,
                totalHours: totalHours
            });

            saveAndRender();
        }

        function removeTeacher(id) {
            teachers = teachers.filter(t => t.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('teachers', JSON.stringify(teachers));
            renderTeachers();
        }

        function renderTeachers() {
            const container = document.getElementById('teacherRowsContainer');
            if (!container) return;

            container.innerHTML = '';
            teachers.forEach((teacher, index) => {
                const tr = document.createElement('tr');
                tr.className = 'lesson-row';

                const classHoursHtml = teacher.classHours
                    .map((ch, idx) => {
                        const subjectDisplay = ch.subject ? `<strong>${ch.subject}</strong>-` : '';
                        return `<span class="class-tag" 
                                      ondblclick="editClassHour('${teacher.id}', ${idx}, this)" 
                                      title="Düzenlemek için çift tıklayın"
                                      style="cursor: pointer;">
                                      ${subjectDisplay}${ch.className} <strong>(${ch.hours}s)</strong>
                                </span>`;
                    })
                    .join(' ');

                tr.innerHTML = `
                    <td><div class="sequence-badge">${index + 1}</div></td>
                    <td><strong>${teacher.name}</strong></td>
                    <td><span class="badge blue">${teacher.branch}</span></td>
                    <td>${classHoursHtml}</td>
                    <td><span class="hour-badge">${teacher.totalHours}</span></td>
                    <td>
                        <button class="delete-btn" onclick="removeTeacher(${teacher.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(tr);
            });
        }

        // Excel Export Function
        function exportToExcel() {
            if (teachers.length === 0) {
                alert('Henüz öğretmen eklenmemiş!');
                return;
            }

            const workbook = XLSX.utils.book_new();

            // Prepare data for Excel
            const excelData = [
                ['Ad Soyad', 'Branş', 'Sınıflar ve Saatler'] // Header
            ];

            teachers.forEach((teacher) => {
                // Format class hours as "MAT-9A-5, FİZ-10B-3"
                const classHoursStr = teacher.classHours
                    .map(ch => {
                        if (ch.subject) {
                            return `${ch.subject}-${ch.className}-${ch.hours}`;
                        }
                        return `${ch.className}-${ch.hours}`;
                    })
                    .join(', ');

                excelData.push([
                    teacher.name,
                    teacher.branch,
                    classHoursStr
                ]);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Öğretmenler');

            // Download the file
            XLSX.writeFile(workbook, 'Ogretmenler.xlsx');
            // alert('Öğretmen listesi Excel dosyasına aktarıldı!');
        }

        // Editing Functionality
        let editingState = null;

        function editClassHour(teacherId, classIndex, element) {
            // Prevent double editing
            if (editingState) return;

            const teacher = teachers.find(t => t.id == teacherId);
            if (!teacher) return;

            const classHour = teacher.classHours[classIndex];
            const currentText = classHour.subject ?
                `${classHour.subject}-${classHour.className}-${classHour.hours}` :
                `${classHour.className}-${classHour.hours}`;

            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.width = '120px';
            input.style.padding = '2px 4px';
            input.style.fontSize = '0.85rem';
            input.style.border = '2px solid #6c5ce7';
            input.style.borderRadius = '4px';

            // Replace span with input
            element.replaceWith(input);
            input.focus();

            editingState = {
                teacherId,
                classIndex,
                input
            };

            // Handle save on blur or enter
            input.addEventListener('blur', () => saveClassHour());
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        function saveClassHour() {
            if (!editingState) return;

            const { teacherId, classIndex, input } = editingState;
            const newValue = input.value.trim();
            const teacher = teachers.find(t => t.id == teacherId);

            if (newValue && teacher) {
                // Parse single class hour using the logic from parseClassHours
                // Reuse parseClassHours but take only the first result since we expect one item
                const parsed = parseClassHours(newValue);

                if (parsed.length > 0) {
                    // Update data
                    teacher.classHours[classIndex] = parsed[0];
                    // Recalculate total hours
                    teacher.totalHours = teacher.classHours.reduce((sum, ch) => sum + ch.hours, 0);
                    localStorage.setItem('teachers', JSON.stringify(teachers));
                } else {
                    alert('Geçersiz format! Örn: MAT-12-A-6');
                }
            }

            editingState = null;
            renderTeachers();
        }

        window.removeTeacher = removeTeacher;
        window.editClassHour = editClassHour; // Make global for inline event
    </script>
</body>

</html>
```